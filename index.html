<!-- frontend/index.html -->
<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Maze Race Multiplayer</title>
<style>
  body { margin:0; background:#111; color:#eee; font-family:sans-serif; }
  #hud { position:fixed; top:10px; left:10px; z-index:10; }
  #status { position:fixed; top:10px; right:10px; }
  canvas { display:block; margin:0 auto; background:#222; image-rendering: pixelated; }
  #room { position:fixed; bottom:10px; left:10px; }
  input, button { margin:4px; }
</style>
</head>
<body>
<div id="hud">بازیکن1 آبی | بازیکن2 نارنجی</div>
<div id="status">در انتظار اتصال…</div>
<div id="room">
  <input id="roomId" placeholder="کد اتاق"/>
  <button id="createBtn">ساخت اتاق</button>
  <button id="joinBtn">ورود به اتاق</button>
</div>
<canvas id="cv" width="840" height="840"></canvas>
<script>
const cell = 20;
// توجه: بعد از استقرار سرور Render، این آدرس را با WSS واقعی جایگزین کن
const wsUrl = "wss://YOUR-RENDER-APP.onrender.com/ws";

// PRNG و تولید هزارتو
function mulberry32(seed){return function(){seed|=0;seed=seed+0x6D2B79F5|0;let t=Math.imul(seed^seed>>>15,1|seed);t=t+Math.imul(t^t>>>7,61|t)^t;return((t^t>>>14)>>>0)/4294967296;};}
function generateMaze(w,h,seed){
  const rnd=mulberry32(seed),grid=Array.from({length:h},()=>Array(w).fill(1));
  const dirs=[[0,-2],[0,2],[-2,0],[2,0]]; let sx=1,sy=1; grid[sy][sx]=0;
  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(rnd()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
  function carve(x,y){shuffle(dirs).forEach(([dx,dy])=>{const nx=x+dx,ny=y+dy;
    if(ny>0&&ny<h-1&&nx>0&&nx<w-1&&grid[ny][nx]===1){grid[y+dy/2][x+dx/2]=0;grid[ny][nx]=0;carve(nx,ny);}});}
  carve(sx,sy);
  return {grid,start:{x:1,y:1},exit:{x:w-2,y:h-2}};
}

const cv = document.getElementById('cv'), ctx = cv.getContext('2d');
let maze = null, me = null, other = null;
let myId = null, roomId = null;
let ws = null;
const keys = {};
window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup',   e => keys[e.code] = false);

function canMove(x,y){ return maze.grid[y]?.[x] === 0; }
function tryMove(p, dx, dy){ const nx=p.x+dx, ny=p.y+dy; if (canMove(nx,ny)) { p.x=nx; p.y=ny; } }
function send(obj){ if(ws && ws.readyState===1) ws.send(JSON.stringify(obj)); }

function draw() {
  ctx.clearRect(0,0,cv.width,cv.height);
  for (let y=0; y<maze.grid.length; y++){
    for (let x=0; x<maze.grid[0].length; x++){
      ctx.fillStyle = maze.grid[y][x] ? '#333' : '#111';
      ctx.fillRect(x*cell, y*cell, cell, cell);
    }
  }
  ctx.fillStyle = '#3c3';
  ctx.fillRect(maze.exit.x*cell, maze.exit.y*cell, cell, cell);
  if (me) { ctx.fillStyle = me.color; ctx.beginPath(); ctx.arc(me.x*cell+cell/2, me.y*cell+cell/2, cell*0.4, 0, Math.PI*2); ctx.fill(); }
  if (other){ ctx.fillStyle = other.color; ctx.beginPath(); ctx.arc(other.x*cell+cell/2, other.y*cell+cell/2, cell*0.4, 0, Math.PI*2); ctx.fill(); }
}

function loop(){
  if (me){
    let dx=0, dy=0;
    if (keys['ArrowUp'] || keys['KeyW']) dy=-1;
    if (keys['ArrowDown'] || keys['KeyS']) dy=+1;
    if (keys['ArrowLeft'] || keys['KeyA']) dx=-1;
    if (keys['ArrowRight'] || keys['KeyD']) dx=+1;
    if (dx || dy) {
      tryMove(me, dx, dy);
      send({type:'move', payload:{x:me.x, y:me.y}});
      if (me.x === maze.exit.x && me.y === maze.exit.y) send({type:'win'});
    }
  }
  draw();
  requestAnimationFrame(loop);
}

// اتصال WS و هندل پیام‌ها
function connect() {
  ws = new WebSocket(wsUrl);
  ws.onopen = () => { document.getElementById('status').textContent = 'وصل شد'; };
  ws.onmessage = (ev) => {
    const msg = JSON.parse(ev.data);
    if (msg.type === 'welcome'){ myId = msg.id; }
    if (msg.type === 'roomCreated'){ roomId = msg.roomId; document.getElementById('status').textContent = `اتاق: ${roomId}`; }
    if (msg.type === 'roomJoined'){ roomId = msg.roomId; document.getElementById('status').textContent = `ورود به اتاق: ${roomId}`; }
    if (msg.type === 'start'){
      maze = generateMaze(msg.w, msg.h, msg.seed);
      const p1 = maze.start;
      const p2 = {x: maze.start.x, y: maze.start.y+1};
      const isP1 = (msg.playerIndex === 0);
      me    = { x: isP1 ? p1.x : p2.x, y: isP1 ? p1.y : p2.y, color: isP1 ? '#39f' : '#f93' };
      other = { x: isP1 ? p2.x : p1.x, y: isP1 ? p2.y : p1.y, color: isP1 ? '#f93' : '#39f' };
    }
    if (msg.type === 'state'){
      const o = msg.players.find(p => p.id !== myId);
      if (o && other) { other.x = o.x; other.y = o.y; }
      if (msg.winner){
        document.getElementById('status').textContent = (msg.winner === myId) ? 'بردی!' : 'حریف برد';
      }
    }
  };
  ws.onclose = () => { document.getElementById('status').textContent = 'قطع شد'; };
}

document.getElementById('createBtn').onclick = () => {
  const rid = Math.random().toString(36).slice(2,7);
  send({type:'createRoom', roomId: rid});
};
document.getElementById('joinBtn').onclick = () => {
  const rid = document.getElementById('roomId').value.trim();
  send({type:'joinRoom', roomId: rid});
};

connect();
requestAnimationFrame(loop);
</script>
</body>
</html>
